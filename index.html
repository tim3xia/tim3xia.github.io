<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Would You Rather - Multiplayer</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; }
    .question { margin: 20px 0; }
    button { margin: 10px 5px; padding: 8px 15px; }
    #result { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Would You Rather - Multiplayer</h2>

  <div id="form">
    <label>你的暱稱：</label><br>
    <input id="nickname" placeholder="輸入暱稱"><br><br>

    <div id="questions"></div>
    <button onclick="submitAnswers()">提交答案</button>
  </div>

  <div id="result" style="display:none;"></div>

  <script type="module">
    // --- Firebase Config (請換成你的專案資訊) ---
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
	const firebaseConfig = {
		apiKey: "AIzaSyAPRJsQCBPbbrbcOFTJDkl3LMwkKf9Lc8E",
		authDomain: "match-wouldyourather.firebaseapp.com",
		databaseURL: "https://match-wouldyourather-default-rtdb.asia-southeast1.firebasedatabase.app",
		projectId: "match-wouldyourather",
		storageBucket: "match-wouldyourather.firebasestorage.app",
		messagingSenderId: "275894995617",
		appId: "1:275894995617:web:7e1845c39badb32a41fee0",
		measurementId: "G-1H6F34WYGJ"
	};

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 題目 ---
    const questions = [
      "Would you rather have the ability to fly 🪽 or be invisible 👻?",
      "Would you rather live in the city 🌆 or the countryside 🌳?",
      "Would you rather always be 10 minutes late ⏰ or always 20 minutes early ⌛?",
      "Would you rather give up social media 📱 or give up TV 📺?",
      "Would you rather be rich 💰 and unknown 🤐 or poor 💸 and famous 🌟?",
      "Would you rather never use the internet again 🌐 or never take an airplane ✈️?",
      "Would you rather read minds 🧠 or predict the future 🔮?",
      "Would you rather be always hot 🔥 or always cold ❄️?",
      "Would you rather explore space 🚀 or the deep sea 🌊?",
      "Would you rather always have free food 🍔 or always have free travel ✈️?"
    ];

    let myNickname = null;
    let myAnswers = null;

    // 顯示題目
    const qDiv = document.getElementById("questions");
    questions.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="q${i}" value="A"> Option A</label>
        <label><input type="radio" name="q${i}" value="B"> Option B</label>
      `;
      qDiv.appendChild(div);
    });

    async function submitAnswers() {
      myNickname = document.getElementById("nickname").value.trim();
      if (!myNickname) { alert("請輸入暱稱"); return; }

      const selected = [];
      for (let i=0; i<questions.length; i++) {
        const choice = document.querySelector(`input[name="q${i}"]:checked`);
        if (!choice) { alert(`請回答第 ${i+1} 題`); return; }
        selected.push(choice.value);
      }
      myAnswers = selected;

      // 寫入 DB（每個暱稱唯一）
      await set(ref(db, "participants/" + myNickname), { nickname: myNickname, answers: selected });
      document.getElementById("form").style.display = "none";
      document.getElementById("result").style.display = "block";
      document.getElementById("result").innerHTML = "<p>等待其他人完成作答中...</p>";
    }

    // --- 監聽資料庫即時更新 ---
    onValue(ref(db, "participants"), (snapshot) => {
      if (!myNickname || !myAnswers) return; // 尚未回答
      if (!snapshot.exists()) return;

      const allData = snapshot.val();
      const entries = Object.values(allData);
      const me = entries.find(p => p.nickname === myNickname);
      if (!me) return;

      let mostSimilar = null, leastSimilar = null;
      let maxScore = -1, minScore = 999;

      entries.forEach(p => {
        if (p.nickname !== me.nickname) {
          let same = 0;
          for (let i=0; i<questions.length; i++) {
            if (p.answers[i] === me.answers[i]) same++;
          }
          let score = same / questions.length;
          if (score > maxScore) { maxScore = score; mostSimilar = p.nickname; }
          if (score < minScore) { minScore = score; leastSimilar = p.nickname; }
        }
      });

      let msg = `<h3>結果 for ${me.nickname}</h3>`;
      if (entries.length === 1) {
        msg += `<p>目前只有你一個人作答，等其他人加入再來看看配對吧！</p>`;
      } else {
        msg += `<p>🎯 你和 <b>${mostSimilar}</b> 最相似 (${Math.round(maxScore*100)}%)</p>`;
        msg += `<p>⚡ 你和 <b>${leastSimilar}</b> 最不相似 (${Math.round(minScore*100)}%)</p>`;
      }

      document.getElementById("result").innerHTML = msg;
    });
  </script>
</body>
</html>
